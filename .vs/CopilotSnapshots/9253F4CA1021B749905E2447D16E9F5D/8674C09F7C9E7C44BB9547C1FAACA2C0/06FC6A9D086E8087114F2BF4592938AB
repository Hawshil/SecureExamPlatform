using SecureExamPlatform.Core;
using SecureExamPlatform.Models;
using SecureExamPlatform.Security;
using System;
using System.Collections.Generic;
using System.ComponentModel;
using System.Linq;
using System.Runtime.InteropServices;
using System.Threading.Tasks;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Input;
using System.Windows.Threading;

namespace SecureExamPlatform.UI
{
    /// <summary>
    /// Main exam window that runs in kiosk mode
    /// </summary>
    public partial class ExamWindow : Window, INotifyPropertyChanged
    {
        // Core components
        private readonly ExamSessionManager _sessionManager;
        private readonly EnhancedProcessMonitor _processMonitor;
        private readonly ScreenshotPrevention _screenshotPrevention;
        private readonly ScreenCaptureBlocker _captureBlocker;

        // Exam state
        private ExamContent _examContent;
        private Dictionary<string, string> _studentAnswers;
        private int _currentQuestionIndex;
        private Question _currentQuestion;

        // Timers
        private readonly DispatcherTimer _examTimer;
        private readonly DispatcherTimer _autoSaveTimer;
        private TimeSpan _remainingTime;

        // Windows API imports for kiosk mode
        [DllImport("user32.dll")]
        private static extern int SetWindowLong(IntPtr hWnd, int nIndex, int dwNewLong);

        [DllImport("user32.dll")]
        private static extern int GetWindowLong(IntPtr hWnd, int nIndex);

        [DllImport("user32.dll")]
        private static extern bool SetWindowPos(IntPtr hWnd, IntPtr hWndInsertAfter,
            int X, int Y, int cx, int cy, uint uFlags);

        private const int GWL_STYLE = -16;
        private const int WS_SY_MENU = 0x80000;
        private static readonly IntPtr HWND_TOPMOST = new IntPtr(-1);
        private const uint SWP_NOSIZE = 0x0001;
        private const uint SWP_NOMOVE = 0x0002;

        public ExamWindow()
        {
            InitializeComponent();
            DataContext = this;

            // Initialize components
            _sessionManager = new ExamSessionManager();
            _processMonitor = new EnhancedProcessMonitor();
            _screenshotPrevention = new ScreenshotPrevention();
            _captureBlocker = new ScreenCaptureBlocker();

            _studentAnswers = new Dictionary<string, string>();

            // Setup timers
            _examTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromSeconds(1)
            };
            _examTimer.Tick += UpdateExamTimer;

            _autoSaveTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromSeconds(30)
            };
            _autoSaveTimer.Tick += AutoSaveAnswers;

            // Configure window for kiosk mode
            ConfigureKioskMode();

            // Start security monitoring
            StartSecurityMonitoring();

        }

        private void ConfigureKioskMode()
        {
            // Set window style for kiosk mode
            this.WindowStyle = WindowStyle.None;
            this.WindowState = WindowState.Maximized;
            this.ResizeMode = ResizeMode.NoResize;
            this.Topmost = true;

            // Prevent Alt+F4
            this.Closing += (s, e) =>
            {
                if (_examContent != null)
                {
                    e.Cancel = true; // Can't close during exam
                    System.Windows.MessageBox.Show("You cannot close the exam window. Please submit your exam first.",
                        "Warning", MessageBoxButton.OK, MessageBoxImage.Warning);
                }
            };

            // Remove window chrome using WinAPI
            var helper = new System.Windows.Interop.WindowInteropHelper(this);
            int style = GetWindowLong(helper.Handle, GWL_STYLE);
            SetWindowLong(helper.Handle, GWL_STYLE, style & ~WS_SY_MENU);

            // Keep window on top
            SetWindowPos(helper.Handle, HWND_TOPMOST, 0, 0, 0, 0, SWP_NOMOVE | SWP_NOSIZE);

            // Capture all keyboard input
            PreviewKeyDown += OnPreviewKeyDown;

            // Prevent screenshot
            _screenshotPrevention.ProtectWindow(helper.Handle);
        }

        private void StartSecurityMonitoring()
        {
            // Start process monitoring
            _processMonitor.StartMonitoring();

            // Start screenshot blocking
            _captureBlocker.StartBlocking();
            _screenshotPrevention.StartProtection();
        }

        private void OnPreviewKeyDown(object sender, System.Windows.Input.KeyEventArgs e)
        {
            // Block dangerous key combinations
            if (Keyboard.Modifiers == ModifierKeys.Alt)
            {
                if (e.Key == Key.Tab || e.Key == Key.F4 || e.Key == Key.Escape)
                {
                    e.Handled = true;
                    LogSecurityEvent("Blocked Alt key combination");
                    return;
                }
            }

            if (Keyboard.Modifiers == ModifierKeys.Windows ||
                e.Key == Key.LWin || e.Key == Key.RWin)
            {
                e.Handled = true;
                LogSecurityEvent("Blocked Windows key");
                return;
            }

            if (Keyboard.Modifiers == (ModifierKeys.Control | ModifierKeys.Alt) &&
                e.Key == Key.Delete)
            {
                e.Handled = true;
                LogSecurityEvent("Blocked Ctrl+Alt+Del");
                return;
            }

            if (Keyboard.Modifiers == (ModifierKeys.Control | ModifierKeys.Shift) &&
                e.Key == Key.Escape)
            {
                e.Handled = true;
                LogSecurityEvent("Blocked Task Manager shortcut");
                return;
            }
        }

        public async Task<bool> StartExam(string studentId, string sessionToken, string examId)
        {
            try
            {
                var result = await _sessionManager.StartSession(studentId, sessionToken, examId);

                if (!result.Success)
                {
                    System.Windows.MessageBox.Show(result.ErrorMessage, "Login Failed",
                        MessageBoxButton.OK, MessageBoxImage.Error);
                    return false;
                }

                // Load exam content
                _examContent = result.ExamContent;
                _currentQuestionIndex = 0;
                _remainingTime = _examContent.Duration;

                // Populate the question list for the UI navigation panel
                Questions.Clear();
                for (int i = 0; i < _examContent.Questions.Count; i++)
                {
                    Questions.Add(new QuestionViewModel
                    {
                        Id = _examContent.Questions[i].Id,
                        Number = i + 1
                    });
                }

                // Display first question
                if (_examContent.Questions.Any())
                {
                    DisplayQuestion(_examContent.Questions[0]);
                }

                // Start timers
                _examTimer.Start();
                _autoSaveTimer.Start();

                // Update UI
                StudentId = studentId;
                QuestionProgress = $"Question {_currentQuestionIndex + 1} of {_examContent.Questions.Count}";
                OnPropertyChanged(nameof(ExamTitle));
                OnPropertyChanged(nameof(QuestionProgress));

                return true;
            }
            catch (Exception ex)
            {
                System.Windows.MessageBox.Show($"Failed to start exam: {ex.Message}", "Error",
                    MessageBoxButton.OK, MessageBoxImage.Error);
                return false;
            }
        }

        private void DisplayQuestion(Question question)
        {
            CurrentQuestionNumber = _currentQuestionIndex + 1;
            _currentQuestion = question;

            // Update question display
            OnPropertyChanged(nameof(CurrentQuestionText));

            // Load saved answer if exists
            if (_studentAnswers.ContainsKey(question.Id))
            {
                LoadSavedAnswer(question.Id);
            }
            else
            {
                AnswerTextBox.Text = string.Empty;
            }
        }

        private void SaveCurrentAnswer()
        {
            if (_currentQuestion == null) return;

            string answer = GetCurrentAnswer();

            if (!string.IsNullOrEmpty(answer))
            {
                _studentAnswers[_currentQuestion.Id] = answer;
            }
        }

        private string GetCurrentAnswer()
        {
            return AnswerTextBox.Text;
        }

        private void LoadSavedAnswer(string questionId)
        {
            if (_studentAnswers.ContainsKey(questionId))
            {
                AnswerTextBox.Text = _studentAnswers[questionId];
            }
        }

        private void NavigateToQuestion(int index)
        {
            if (_examContent == null || index < 0 || index >= _examContent.Questions.Count) return;

            SaveCurrentAnswer();
            _currentQuestionIndex = index;
            DisplayQuestion(_examContent.Questions[index]);
            QuestionProgress = $"Question {_currentQuestionIndex + 1} of {_examContent.Questions.Count}";
        }

        private void OnPreviousQuestion()
        {
            NavigateToQuestion(_currentQuestionIndex - 1);
        }

        private void OnNextQuestion()
        {
            NavigateToQuestion(_currentQuestionIndex + 1);
        }

        private bool isSubmitted = false;

        private async void OnSubmitExam()
        {
            var result = System.Windows.MessageBox.Show(
                "Are you sure you want to submit your exam? This action cannot be undone.",
                "Confirm Submission",
                MessageBoxButton.YesNo,
                MessageBoxImage.Question);

            if (result != MessageBoxResult.Yes) return;

            SaveCurrentAnswer();
            _examTimer.Stop();
            _autoSaveTimer.Stop();

            var submission = new ExamSubmission
            {
                StudentId = this.StudentId,
                ExamId = _examContent.ExamId,
                Answers = _studentAnswers,
                SubmissionTime = DateTime.Now,
                TimeSpent = _examContent.Duration - _remainingTime
            };

            await SaveSubmission(submission);
            isSubmitted = true;
            _sessionManager.EndSession(true);

            System.Windows.MessageBox.Show(
                "Your exam has been submitted successfully.\n\n" +
                $"Submission Time: {submission.SubmissionTime:yyyy-MM-dd HH:mm:ss}\n" +
                $"Time Spent: {submission.TimeSpent.TotalMinutes:F0} minutes\n" +
                $"Questions Answered: {submission.Answers.Count}/{_examContent.Questions.Count}",
                "Exam Submitted",
                MessageBoxButton.OK,
                MessageBoxImage.Information);

            CleanupAndExit();
        }

        private async Task SaveSubmission(ExamSubmission submission)
        {
            await Task.Run(() =>
            {
                var json = System.Text.Json.JsonSerializer.Serialize(submission);
                var encrypted = EncryptData(json);
                var filename = $"submission_{submission.StudentId}_{DateTime.Now:yyyyMMdd_HHmmss}.dat";
                string submissionPath = System.IO.Path.Combine(
                    Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData),
                    "SecureExam",
                    "Submissions",
                    filename);
                System.IO.File.WriteAllBytes(submissionPath, encrypted);
            });
        }

        private byte[] EncryptData(string data)
        {
            return System.Text.Encoding.UTF8.GetBytes(data);
        }

        private void UpdateExamTimer(object sender, EventArgs e)
        {
            _remainingTime = _remainingTime.Subtract(TimeSpan.FromSeconds(1));

            if (_remainingTime <= TimeSpan.Zero)
            {
                _examTimer.Stop();
                System.Windows.MessageBox.Show("Time is up! The exam will now be submitted automatically.",
                    "Time's Up", MessageBoxButton.OK, MessageBoxImage.Information);
                OnSubmitExam();
                return;
            }

            OnPropertyChanged(nameof(RemainingTimeDisplay));

            if (_remainingTime.TotalSeconds > 299 && _remainingTime.TotalSeconds <= 300)
            {
                System.Windows.MessageBox.Show("You have 5 minutes remaining!", "Time Warning",
                    MessageBoxButton.OK, MessageBoxImage.Warning);
            }
        }

        private void AutoSaveAnswers(object sender, EventArgs e)
        {
            SaveCurrentAnswer();
            LogEvent("Auto-saved answers");
        }

        private void LogSecurityEvent(string message)
        {
            Console.WriteLine($"[SECURITY] {message}");
        }

        private void LogEvent(string message)
        {
            Console.WriteLine($"[EXAM] {message}");
        }

        private void CleanupAndExit()
        {
            try
            {
                _processMonitor?.StopMonitoring();
                _screenshotPrevention?.StopProtection();
                _captureBlocker?.StopBlocking();
                _processMonitor?.Dispose();
                _screenshotPrevention?.Dispose();

                // Ensure session is ended
                if (!isSubmitted)
                {
                    _sessionManager.EndSession(false);
                }
            }
            finally
            {
                Application.Current.Shutdown();
            }
        }

        // Event Handlers
        private void PreviousButton_Click(object sender, RoutedEventArgs e) => OnPreviousQuestion();
        private void NextButton_Click(object sender, RoutedEventArgs e) => OnNextQuestion();
        private void SubmitButton_Click(object sender, RoutedEventArgs e) => OnSubmitExam();

        private void QuestionButton_Click(object sender, RoutedEventArgs e)
        {
            if (sender is System.Windows.Controls.Button button && button.Tag is string questionId)
            {
                var questionIndex = _examContent.Questions.FindIndex(q => q.Id == questionId);
                if (questionIndex >= 0)
                {
                    NavigateToQuestion(questionIndex);
                }
            }
        }

        private void FlagButton_Click(object sender, RoutedEventArgs e)
        {
            if (_currentQuestion != null)
            {
                if (_flaggedQuestions.Contains(_currentQuestion.Id))
                {
                    _flaggedQuestions.Remove(_currentQuestion.Id);
                    ShowNotification("Question unflagged");
                }
                else
                {
                    _flaggedQuestions.Add(_currentQuestion.Id);
                    ShowNotification("Question flagged for review");
                }
                UpdateQuestionListUI();
            }
        }

        private void AnswerTextBox_TextChanged(object sender, TextChangedEventArgs e)
        {
            if (_currentQuestion != null && sender is System.Windows.Controls.TextBox textBox)
            {
                if (!string.IsNullOrWhiteSpace(textBox.Text))
                {
                    _attemptedQuestions.Add(_currentQuestion.Id);
                }
                ShowAutoSaveIndicator();

                _autoSaveDebounceTimer?.Stop();
                _autoSaveDebounceTimer = new DispatcherTimer
                {
                    Interval = TimeSpan.FromSeconds(2)
                };
                _autoSaveDebounceTimer.Tick += (s, args) =>
                {
                    SaveCurrentAnswer();
                    _autoSaveDebounceTimer.Stop();
                };
                _autoSaveDebounceTimer.Start();
            }
        }

        private void DismissWarning_Click(object sender, RoutedEventArgs e) => HideWarning();

        private void ShowWarning(string message)
        {
            Dispatcher.Invoke(() =>
            {
                WarningMessage.Text = message;
                WarningOverlay.Visibility = Visibility.Visible;
            });
        }

        private void HideWarning()
        {
            Dispatcher.Invoke(() => { WarningOverlay.Visibility = Visibility.Collapsed; });
        }

        private void ShowAutoSaveIndicator()
        {
            Dispatcher.Invoke(() =>
            {
                AutoSaveIndicator.Visibility = Visibility.Visible;
                var timer = new DispatcherTimer { Interval = TimeSpan.FromSeconds(2) };
                timer.Tick += (s, e) =>
                {
                    AutoSaveIndicator.Visibility = Visibility.Collapsed;
                    timer.Stop();
                };
                timer.Start();
            });
        }

        private void ShowNotification(string message) => LogEvent($"NOTIFICATION: {message}");

        private void UpdateQuestionListUI()
        {
            Dispatcher.Invoke(() =>
            {
                var qList = new List<QuestionViewModel>();
                for (int i = 0; i < _examContent.Questions.Count; i++)
                {
                    var q = _examContent.Questions[i];
                    var vm = new QuestionViewModel
                    {
                        Id = q.Id,
                        Number = i + 1,
                        StatusIcon = _flaggedQuestions.Contains(q.Id) ? "🚩" : "",
                        StatusColor = _attemptedQuestions.Contains(q.Id) ? "#2e7d32" : "#444"
                    };
                    qList.Add(vm);
                }
                this.Questions = qList;
                OnPropertyChanged(nameof(Questions));
            });
        }

        // Properties for Data Binding
        public string ExamTitle => _examContent?.Title ?? "Loading Exam...";

        private string _studentId = "N/A";
        public string StudentId
        {
            get => _studentId;
            set { _studentId = value; OnPropertyChanged(nameof(StudentId)); }
        }

        private string _questionProgress = "Loading...";
        public string QuestionProgress
        {
            get => _questionProgress;
            set { _questionProgress = value; OnPropertyChanged(nameof(QuestionProgress)); }
        }

        public string CurrentQuestionText => _currentQuestion?.Text ?? "";
        public string RemainingTimeDisplay => $"{_remainingTime.Hours:D2}:{_remainingTime.Minutes:D2}:{_remainingTime.Seconds:D2}";
        public List<QuestionViewModel> Questions { get; set; } = new List<QuestionViewModel>();

        public event PropertyChangedEventHandler PropertyChanged;
        private void OnPropertyChanged(string propertyName) => PropertyChanged?.Invoke(this, new PropertyChangedEventArgs(propertyName));

        // Helper Classes and Fields
        public class QuestionViewModel
        {
            public string Id { get; set; } = "";
            public int Number { get; set; }
            public string StatusColor { get; set; } = "#444";
            public string StatusIcon { get; set; } = "";
        }

        private readonly HashSet<string> _attemptedQuestions = new HashSet<string>();
        private readonly HashSet<string> _flaggedQuestions = new HashSet<string>();
        private DispatcherTimer _autoSaveDebounceTimer;

        private int _currentQuestionNumber = 1;
        public int CurrentQuestionNumber
        {
            get => _currentQuestionNumber;
            set
            {
                _currentQuestionNumber = value;
                OnPropertyChanged(nameof(CurrentQuestionNumber));
            }
        }

        protected override void OnClosing(CancelEventArgs e)
        {
            if (_examContent != null && !isSubmitted)
            {
                var result = MessageBox.Show(
                    "Are you sure you want to exit? This will end your exam session.",
                    "Confirm Exit",
                    MessageBoxButton.YesNo,
                    MessageBoxImage.Warning);

                if (result == MessageBoxResult.No)
                {
                    e.Cancel = true;
                    return;
                }

                // End the session properly
                _sessionManager.EndSession(false);
            }

            base.OnClosing(e);
        }
    }
}
