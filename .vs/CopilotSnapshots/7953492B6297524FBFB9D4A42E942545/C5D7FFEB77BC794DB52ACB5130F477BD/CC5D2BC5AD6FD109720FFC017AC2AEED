using System;
using System.Threading.Tasks;
using Xunit;
using SecureExamPlatform.Core;
using SecureExamPlatform.Models;

namespace SecureExamPlatform.Tests.Core
{
    public class ExamSessionManagerTests
    {
        private readonly ExamSessionManager _sessionManager;

        public ExamSessionManagerTests()
        {
            _sessionManager = new ExamSessionManager();
        }

        [Fact]
        public async Task StartSession_WithValidCredentials_ShouldCreateSession()
        {
            // Arrange
            string studentId = "STU001";
            string examId = "EXAM001";
            string accessToken = "TEST-TOKEN";

            // Act
            var result = await _sessionManager.StartSession(studentId, accessToken, examId);

            // Assert
            Assert.True(result.Success);
            Assert.NotNull(result.ExamContent);
            Assert.False(result.IsResumed);
            Assert.True(_sessionManager.IsSessionActive());

            var currentSession = _sessionManager.GetCurrentSession();
            Assert.NotNull(currentSession);
            Assert.Equal(studentId, currentSession.StudentId);
            Assert.Equal(examId, currentSession.ExamId);
            Assert.True(currentSession.IsActive);
        }

        [Fact]
        public async Task EndSession_ShouldTerminateActiveSession()
        {
            // Arrange
            string studentId = "STU001";
            string examId = "EXAM001";
            string accessToken = "TEST-TOKEN";
            
            await _sessionManager.StartSession(studentId, accessToken, examId);

            // Act
            _sessionManager.EndSession(submitted: true);

            // Assert
            Assert.False(_sessionManager.IsSessionActive());
            Assert.Null(_sessionManager.GetCurrentSession());

            // Verify session events were recorded
            var events = _sessionManager.GetSessionEvents();
            Assert.Contains(events, e => e.EventType == "SessionEnd");
        }

        [Fact]
        public async Task StartSession_WithExistingSession_ShouldFail()
        {
            // Arrange
            string studentId = "STU001";
            string examId = "EXAM001";
            string accessToken = "TEST-TOKEN";
            
            // Start first session
            await _sessionManager.StartSession(studentId, accessToken, examId);

            // Act
            var result = await _sessionManager.StartSession(studentId, accessToken, examId);

            // Assert
            Assert.False(result.Success);
            Assert.Contains("session already active", result.ErrorMessage.ToLower());
        }

        [Fact]
        public async Task GetSessionEvents_ShouldTrackSessionActivity()
        {
            // Arrange
            string studentId = "STU001";
            string examId = "EXAM001";
            string accessToken = "TEST-TOKEN";
            
            // Act
            await _sessionManager.StartSession(studentId, accessToken, examId);
            _sessionManager.EndSession(submitted: true);

            // Assert
            var events = _sessionManager.GetSessionEvents();
            Assert.Contains(events, e => e.EventType == "SessionStart");
            Assert.Contains(events, e => e.EventType == "SessionEnd");
        }
    }
}}