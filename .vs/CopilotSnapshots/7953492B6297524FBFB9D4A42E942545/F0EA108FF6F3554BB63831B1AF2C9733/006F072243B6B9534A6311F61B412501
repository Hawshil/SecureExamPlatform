using System;
using System.Collections.Generic;
using System.IO;
using System.Linq;
using System.Text.Json;
using SecureExamPlatform.Models;

namespace SecureExamPlatform.Grading
{
    /// <summary>
    /// Automatic grading tool for MCQ questions and submission analysis
    /// </summary>
    public class GradingTool
    {
        private string examsDirectory;
        private string submissionsDirectory;

        public GradingTool()
        {
            string appData = Environment.GetFolderPath(Environment.SpecialFolder.LocalApplicationData);
            submissionsDirectory = Path.Combine(appData, "SecureExam", "Submissions");

            string appDirectory = AppDomain.CurrentDomain.BaseDirectory;
            examsDirectory = Path.Combine(appDirectory, "Exams");
        }

        public class GradingResult
        {
            public string StudentId { get; set; }
            public string ExamId { get; set; }
            public int TotalMcqMarks { get; set; }
            public int EarnedMcqMarks { get; set; }
            public int TotalSubjectiveMarks { get; set; }
            public int QuestionsAnswered { get; set; }
            public int TotalQuestions { get; set; }
            public Dictionary<string, QuestionResult> QuestionResults { get; set; }
            public DateTime SubmissionTime { get; set; }
            public TimeSpan TimeSpent { get; set; }
        }

        public class QuestionResult
        {
            public string QuestionId { get; set; }
            public string QuestionText { get; set; }
            public string QuestionType { get; set; }
            public string StudentAnswer { get; set; }
            public string CorrectAnswer { get; set; }
            public bool IsCorrect { get; set; }
            public int MarksAwarded { get; set; }
            public int TotalMarks { get; set; }
        }

        /// <summary>
        /// Grade all submissions for a specific exam
        /// </summary>
        public List<GradingResult> GradeExam(string examId)
        {
            var results = new List<GradingResult>();

            // Load exam
            var exam = LoadExam(examId);
            if (exam == null)
            {
                Console.WriteLine($"Error: Exam '{examId}' not found");
                return results;
            }

            // Find all submissions for this exam
            var submissionFiles = Directory.GetFiles(submissionsDirectory, $"*{examId}*.json");

            if (submissionFiles.Length == 0)
            {
                Console.WriteLine($"No submissions found for exam '{examId}'");
                return results;
            }

            foreach (var file in submissionFiles)
            {
                try
                {
                    var result = GradeSubmission(file, exam);
                    if (result != null)
                    {
                        results.Add(result);
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error grading {file}: {ex.Message}");
                }
            }

            return results;
        }

        /// <summary>
        /// Grade a single submission
        /// </summary>
        public GradingResult GradeSubmission(string submissionFile, ExamContent exam)
        {
            var json = File.ReadAllText(submissionFile);
            var submission = JsonSerializer.Deserialize<ExamSubmission>(json);

            if (submission == null)
            {
                return null;
            }

            var result = new GradingResult
            {
                StudentId = submission.StudentId,
                ExamId = submission.ExamId,
                SubmissionTime = submission.SubmissionTime,
                TimeSpent = submission.TimeSpent,
                QuestionResults = new Dictionary<string, QuestionResult>(),
                TotalQuestions = exam.Questions.Count,
                QuestionsAnswered = submission.Answers.Count
            };

            // Grade each question
            foreach (var question in exam.Questions)
            {
                var questionResult = GradeQuestion(question, submission.Answers);
                result.QuestionResults[question.Id] = questionResult;

                if (question.Type == QuestionType.MultipleChoice)
                {
                    result.TotalMcqMarks += question.Points;
                    if (questionResult.IsCorrect)
                    {
                        result.EarnedMcqMarks += question.Points;
                    }
                }
                else
                {
                    result.TotalSubjectiveMarks += question.Points;
                }
            }

            return result;
        }

        /// <summary>
        /// Grade individual question
        /// </summary>
        private QuestionResult GradeQuestion(Question question, Dictionary<string, string> answers)
        {
            var result = new QuestionResult
            {
                QuestionId = question.Id,
                QuestionText = question.Text,
                QuestionType = question.Type.ToString(),
                TotalMarks = question.Points,
                MarksAwarded = 0,
                IsCorrect = false
            };

            // Check if student answered this question
            if (!answers.TryGetValue(question.Id, out string studentAnswer))
            {
                result.StudentAnswer = "[Not Answered]";
                return result;
            }

            result.StudentAnswer = studentAnswer;

            // Grade based on question type
            if (question.Type == QuestionType.MultipleChoice)
            {
                // Parse the answer index
                if (int.TryParse(studentAnswer, out int selectedIndex))
                {
                    if (selectedIndex >= 0 && selectedIndex < question.Options.Count)
                    {
                        string selectedOption = question.Options[selectedIndex];
                        result.StudentAnswer = $"{selectedOption} (Option {selectedIndex + 1})";
                        result.CorrectAnswer = question.CorrectAnswer;

                        // Check if correct
                        if (selectedOption == question.CorrectAnswer ||
                            selectedOption.Trim().Equals(question.CorrectAnswer?.Trim(), StringComparison.OrdinalIgnoreCase))
                        {
                            result.IsCorrect = true;
                            result.MarksAwarded = question.Points;
                        }
                    }
                }
            }
            else
            {
                // Subjective questions need manual grading
                result.StudentAnswer = studentAnswer;
                result.CorrectAnswer = "[Requires Manual Grading]";
            }

            return result;
        }

        /// <summary>
        /// Load exam from file
        /// </summary>
        private ExamContent LoadExam(string examId)
        {
            try
            {
                var examFile = Path.Combine(examsDirectory, $"{examId}.json");

                if (!File.Exists(examFile))
                {
                    // Try to find the exam in all JSON files
                    var files = Directory.GetFiles(examsDirectory, "*.json");
                    foreach (var file in files)
                    {
                        var content = JsonSerializer.Deserialize<ExamContent>(
                            File.ReadAllText(file),
                            new JsonSerializerOptions { PropertyNameCaseInsensitive = true });

                        if (content?.ExamId == examId)
                        {
                            return content;
                        }
                    }
                    return null;
                }

                string json = File.ReadAllText(examFile);
                return JsonSerializer.Deserialize<ExamContent>(json,
                    new JsonSerializerOptions { PropertyNameCaseInsensitive = true });
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error loading exam: {ex.Message}");
                return null;
            }
        }

        /// <summary>
        /// Generate a detailed grading report
        /// </summary>
        public void GenerateReport(List<GradingResult> results, string outputPath = null)
        {
            if (results == null || results.Count == 0)
            {
                Console.WriteLine("No results to report");
                return;
            }

            var report = new System.Text.StringBuilder();
            report.AppendLine("╔═══════════════════════════════════════════════════════════╗");
            report.AppendLine("║         SECURE EXAM PLATFORM - GRADING REPORT            ║");
            report.AppendLine("╚═══════════════════════════════════════════════════════════╝");
            report.AppendLine();
            report.AppendLine($"Exam ID: {results[0].ExamId}");
            report.AppendLine($"Total Submissions: {results.Count}");
            report.AppendLine($"Report Generated: {DateTime.Now:yyyy-MM-dd HH:mm:ss}");
            report.AppendLine();
            report.AppendLine(new string('=', 80));
            report.AppendLine();

            // Sort by student ID
            var sortedResults = results.OrderBy(r => r.StudentId).ToList();

            foreach (var result in sortedResults)
            {
                report.AppendLine($"STUDENT ID: {result.StudentId}");
                report.AppendLine(new string('-', 80));
                report.AppendLine($"Submission Time: {result.SubmissionTime:yyyy-MM-dd HH:mm:ss}");
                report.AppendLine($"Time Spent: {result.TimeSpent.Hours}h {result.TimeSpent.Minutes}m");
                report.AppendLine($"Questions Answered: {result.QuestionsAnswered}/{result.TotalQuestions}");
                report.AppendLine();

                // MCQ Score
                double mcqPercentage = result.TotalMcqMarks > 0
                    ? (result.EarnedMcqMarks * 100.0 / result.TotalMcqMarks)
                    : 0;

                report.AppendLine($"MCQ Score: {result.EarnedMcqMarks}/{result.TotalMcqMarks} ({mcqPercentage:F1}%)");

                if (result.TotalSubjectiveMarks > 0)
                {
                    report.AppendLine($"Subjective Questions: {result.TotalSubjectiveMarks} marks (Manual Grading Required)");
                }

                report.AppendLine();
                report.AppendLine("Question-wise Analysis:");
                report.AppendLine();

                foreach (var qResult in result.QuestionResults.Values.OrderBy(q => q.QuestionId))
                {
                    string status = qResult.QuestionType == "MultipleChoice"
                        ? (qResult.IsCorrect ? "✓ CORRECT" : "✗ INCORRECT")
                        : "⏳ PENDING";

                    report.AppendLine($"  [{qResult.QuestionId}] {status}");
                    report.AppendLine($"  Question: {qResult.QuestionText}");

                    if (qResult.QuestionType == "MultipleChoice")
                    {
                        report.AppendLine($"  Student Answer: {qResult.StudentAnswer}");
                        report.AppendLine($"  Correct Answer: {qResult.CorrectAnswer}");
                        report.AppendLine($"  Marks: {qResult.MarksAwarded}/{qResult.TotalMarks}");
                    }
                    else
                    {
                        int answerLength = qResult.StudentAnswer?.Length ?? 0;
                        report.AppendLine($"  Answer Length: {answerLength} characters");
                        report.AppendLine($"  Marks: [Manual Grading Required] /{qResult.TotalMarks}");

                        // Show first 100 characters of answer
                        if (answerLength > 0)
                        {
                            string preview = qResult.StudentAnswer.Length > 100
                                ? qResult.StudentAnswer.Substring(0, 100) + "..."
                                : qResult.StudentAnswer;
                            report.AppendLine($"  Preview: {preview}");
                        }
                    }

                    report.AppendLine();
                }

                report.AppendLine(new string('=', 80));
                report.AppendLine();
            }

            // Summary statistics
            report.AppendLine();
            report.AppendLine("╔═══════════════════════════════════════════════════════════╗");
            report.AppendLine("║                    SUMMARY STATISTICS                     ║");
            report.AppendLine("╚═══════════════════════════════════════════════════════════╝");
            report.AppendLine();

            double avgMcqScore = results.Average(r =>
                r.TotalMcqMarks > 0 ? (r.EarnedMcqMarks * 100.0 / r.TotalMcqMarks) : 0);

            report.AppendLine($"Average MCQ Score: {avgMcqScore:F1}%");
            report.AppendLine($"Highest MCQ Score: {results.Max(r => r.TotalMcqMarks > 0 ? (r.EarnedMcqMarks * 100.0 / r.TotalMcqMarks) : 0):F1}%");
            report.AppendLine($"Lowest MCQ Score: {results.Min(r => r.TotalMcqMarks > 0 ? (r.EarnedMcqMarks * 100.0 / r.TotalMcqMarks) : 0):F1}%");
            report.AppendLine($"Average Time Spent: {TimeSpan.FromTicks((long)results.Average(r => r.TimeSpent.Ticks)):hh\\:mm\\:ss}");

            // Save to file
            if (string.IsNullOrEmpty(outputPath))
            {
                outputPath = Path.Combine(
                    Environment.GetFolderPath(Environment.SpecialFolder.Desktop),
                    $"GradingReport_{results[0].ExamId}_{DateTime.Now:yyyyMMdd_HHmmss}.txt");
            }

            File.WriteAllText(outputPath, report.ToString());
            Console.WriteLine($"\n✓ Report saved to: {outputPath}");
            Console.WriteLine(report.ToString());
        }

        /// <summary>
        /// Generate CSV export for further analysis
        /// </summary>
        public void ExportToCSV(List<GradingResult> results, string outputPath = null)
        {
            if (results == null || results.Count == 0)
            {
                Console.WriteLine("No results to export");
                return;
            }

            if (string.IsNullOrEmpty(outputPath))
            {
                outputPath = Path.Combine(
                    Environment.GetFolderPath(Environment.SpecialFolder.Desktop),
                    $"GradingExport_{results[0].ExamId}_{DateTime.Now:yyyyMMdd_HHmmss}.csv");
            }

            using (var writer = new StreamWriter(outputPath))
            {
                // Header
                writer.WriteLine("Student ID,MCQ Score,MCQ Total,MCQ %,Subjective Total,Questions Answered,Total Questions,Time Spent (mins),Submission Time");

                foreach (var result in results.OrderBy(r => r.StudentId))
                {
                    double mcqPercent = result.TotalMcqMarks > 0
                        ? (result.EarnedMcqMarks * 100.0 / result.TotalMcqMarks)
                        : 0;

                    writer.WriteLine($"{result.StudentId},{result.EarnedMcqMarks},{result.TotalMcqMarks},{mcqPercent:F1},{result.TotalSubjectiveMarks},{result.QuestionsAnswered},{result.TotalQuestions},{result.TimeSpent.TotalMinutes:F1},{result.SubmissionTime:yyyy-MM-dd HH:mm:ss}");
                }
            }

            Console.WriteLine($"✓ CSV exported to: {outputPath}");
        }
    }

    // Command-line interface for the grading tool
    class Program
    {
        static void Main(string[] args)
        {
            Console.WriteLine("╔════════════════════════════════════════════════════════╗");
            Console.WriteLine("║   SECURE EXAM PLATFORM - AUTOMATIC GRADING TOOL       ║");
            Console.WriteLine("╚════════════════════════════════════════════════════════╝");
            Console.WriteLine();

            var grader = new GradingTool();

            if (args.Length > 0)
            {
                // Command-line mode
                string examId = args[0];
                GradeExamCLI(grader, examId);
            }
            else
            {
                // Interactive mode
                GradeExamInteractive(grader);
            }
        }

        static void GradeExamCLI(GradingTool grader, string examId)
        {
            Console.WriteLine($"Grading exam: {examId}");
            var results = grader.GradeExam(examId);

            if (results.Count > 0)
            {
                grader.GenerateReport(results);
                grader.ExportToCSV(results);
            }
        }

        static void GradeExamInteractive(GradingTool grader)
        {
            Console.Write("Enter Exam ID to grade: ");
            string examId = Console.ReadLine()?.Trim();

            if (string.IsNullOrEmpty(examId))
            {
                Console.WriteLine("Error: Exam ID is required");
                return;
            }

            Console.WriteLine($"\nGrading exam: {examId}");
            Console.WriteLine("Please wait...\n");

            var results = grader.GradeExam(examId);

            if (results.Count == 0)
            {
                Console.WriteLine("No submissions found or error occurred.");
                return;
            }

            Console.WriteLine($"✓ Graded {results.Count} submissions");
            Console.WriteLine("\nGenerating reports...");

            grader.GenerateReport(results);
            grader.ExportToCSV(results);

            Console.WriteLine("\n✓ Grading complete!");
            Console.WriteLine("\nPress any key to exit...");
            Console.ReadKey();
        }
    }
}